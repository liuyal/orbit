# Stage 1: Build the Angular application
FROM node:alpine AS build

# Maintainer information
LABEL maintainer="jerry"
WORKDIR /app

# Copy application files and build the Angular app
COPY frontend/package*.json ./
RUN npm ci

# Copy the rest of the application source code
COPY frontend/ .
RUN npm run build -- --configuration=production --output-mode=static

# Debug: List the dist directory to see what was created
RUN echo "=== Build output ===" && \
    ls -la dist/ && \
    echo "=== dist/orbit-app/ ===" && \
    ls -la dist/orbit-app/ && \
    echo "=== dist/orbit-app/browser/ ===" && \
    ls -la dist/orbit-app/browser/ || echo "No browser folder"

# Stage 2: Serve the application with Nginx
FROM nginx:alpine

# Copy built Angular app from build stage (browser folder for SSR apps)
# For static builds, files are directly in dist/orbit-app/browser
COPY --from=build /app/dist/orbit-app/browser /usr/share/nginx/html

# Rename index.csr.html to index.html for nginx
RUN mv /usr/share/nginx/html/index.csr.html /usr/share/nginx/html/index.html

# Remove default nginx HTML
RUN rm -rf /usr/share/nginx/html/50x.html || true

# Fix permissions
RUN chmod -R 755 /usr/share/nginx/html && \
    chown -R nginx:nginx /usr/share/nginx/html

# Verify files were copied
RUN echo "=== Nginx html contents ===" && ls -la /usr/share/nginx/html/

# Copy custom nginx configuration
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# Remove the default nginx welcome page config
RUN rm -f /etc/nginx/conf.d/default.conf.dpkg-dist /etc/nginx/conf.d/default.conf.default

# Verify nginx config
RUN echo "=== Nginx config ===" && cat /etc/nginx/conf.d/default.conf

# Expose port 80 and start Nginx server
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]