<app-navbar [showBackButton]="true" [backButtonText]="'Back to Test Cycles'"
    [backButtonAction]="goBack.bind(this)"></app-navbar>

<div class="content">
    @if (loading) {
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
    } @else {
    <div class="tabs-container">
        <div class="tabs">
            @if (isEditMode) {
            <button type="button" class="tab" [class.active]="activeTab === 'test-executions'" (click)="onTabChange('test-executions')">
                <i class="fa-solid fa-play"></i>
                Test Executions
            </button>
            }
            <button type="button" class="tab" [class.active]="activeTab === 'details'" (click)="onTabChange('details')">
                <i class="fa-solid fa-info-circle"></i>
                Details
            </button>
            @if (isEditMode && activeTab === 'test-executions') {
            <button type="button" class="create-btn-tab" (click)="addTestCase()">
                <i class="fa-solid fa-plus"></i>
            </button>
            }
        </div>

        <div class="tab-content">
            @if (activeTab === 'test-executions') {
            <div class="test-executions-container">
                <div class="split-view">
                    <div class="test-cases-panel">
                        <div class="panel-header">
                            <h4>Test Cases</h4>
                            <span class="count-badge">{{ testCycle.executions?.length || 0 }}</span>
                        </div>
                        <div class="test-cases-list">
                            @if (testCycle.executions && testCycle.executions.length > 0) {
                                @for (execution of testCycle.executions; track execution.test_case_key) {
                                <div class="test-case-item" 
                                     [class.selected]="selectedExecution === execution"
                                     (click)="selectExecution(execution)">
                                    <div class="test-case-header">
                                        <span class="test-case-key">{{ execution.test_case_key }}</span>
                                        <span class="status-indicator" [attr.data-status]="execution.result || 'NOT_EXECUTED'">
                                            {{ (execution.result || 'NOT_EXECUTED').charAt(0) }}
                                        </span>
                                    </div>
                                    <div class="test-case-title">{{ execution.title || 'Untitled' }}</div>
                                </div>
                                }
                            } @else {
                                <div class="empty-message">
                                    <i class="fa-solid fa-flask"></i>
                                    <p>No test cases added to this cycle</p>
                                    <p class="hint">Click "Add Test Case" to get started</p>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="execution-details-panel">
                        @if (selectedExecution) {
                        <div class="details-content">
                            <div class="details-header">
                                <h4>{{ selectedExecution.test_case_key }}</h4>
                                <div class="result-selector">
                                    <label>Result:</label>
                                    <select [(ngModel)]="selectedExecution.result" name="result">
                                        <option value="NOT_EXECUTED">Not Executed</option>
                                        <option value="PASS">Pass</option>
                                        <option value="FAIL">Fail</option>
                                        <option value="BLOCKED">Blocked</option>
                                    </select>
                                </div>
                            </div>
                            <div class="details-section">
                                <label>Title</label>
                                <p>{{ selectedExecution.title || 'N/A' }}</p>
                            </div>
                            <div class="details-section">
                                <label>Description</label>
                                <p>{{ selectedExecution.description || 'N/A' }}</p>
                            </div>
                            <div class="details-section">
                                <label>Test Script</label>
                                <pre>{{ selectedExecution.test_script || 'No script provided' }}</pre>
                            </div>
                            <div class="details-section">
                                <label>Comment</label>
                                <textarea [(ngModel)]="selectedExecution.comment" 
                                          name="comment"
                                          placeholder="Add execution notes or comments..."
                                          rows="4"></textarea>
                            </div>
                            <div class="details-actions">
                                <button type="button" class="btn btn-secondary">Remove from Cycle</button>
                                <button type="button" class="btn btn-primary">Save Changes</button>
                            </div>
                        </div>
                        } @else {
                        <div class="no-selection">
                            <i class="fa-solid fa-hand-pointer"></i>
                            <p>Select a test case to view details</p>
                        </div>
                        }
                    </div>
                </div>
            </div>
            } @else if (activeTab === 'details') {
            <div class="form-container">
                <form (ngSubmit)="submitTestCycle()">
                    @if (apiError) {
                    <div class="alert-error">
                        {{ apiError }}
                    </div>
                    }
                    <div class="form-row">
                        <div class="form-group">
                            <label for="test_cycle_key">Test Cycle Key</label>
                            <input type="text" id="test_cycle_key" [(ngModel)]="testCycle.test_cycle_key" name="test_cycle_key"
                                placeholder="Enter test cycle key" [required]="!isEditMode"
                                [class.error]="errors.test_cycle_key" [disabled]="isEditMode" />
                            @if (errors.test_cycle_key) {
                            <span class="error-message">{{ errors.test_cycle_key }}</span>
                            }

                            <label for="title" style="margin-top:16px;">Title</label>
                            <input type="text" id="title" [(ngModel)]="testCycle.title" name="title"
                                placeholder="Enter test cycle title" required [class.error]="errors.title" />
                            @if (errors.title) {
                            <span class="error-message">{{ errors.title }}</span>
                            }
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" [(ngModel)]="testCycle.description" name="description"
                            placeholder="Enter test cycle description" rows="4"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                    
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
                        <button type="submit" class="btn btn-primary">{{ isEditMode ? 'Update' : 'Create' }}</button>
                    </div>
                </form>
            </div>
            }
        </div>
    </div>
    }
</div>
