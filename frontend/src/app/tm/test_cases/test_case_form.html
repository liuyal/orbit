<app-navbar [showBackButton]="true" [backButtonText]="'Back to Test Cases'"
    [backButtonAction]="goBack.bind(this)"></app-navbar>

<div class="content">
    @if (loading) {
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
    } @else {
    <div class="tabs-container">
        <div class="tabs">
            <button type="button" class="tab" [class.active]="activeTab === 'details'" (click)="onTabChange('details')">
                <i class="fa-solid fa-info-circle"></i>
                Details
            </button>
            <button type="button" class="tab" [class.active]="activeTab === 'script'" (click)="onTabChange('script')">
                <i class="fa-solid fa-file-lines"></i>
                Test Script
            </button>
            <button type="button" class="tab" [class.active]="activeTab === 'links'" (click)="onTabChange('links')">
                <i class="fa-solid fa-link"></i>
                Links
            </button>
            @if (isEditMode) {
            <button type="button" class="tab" [class.active]="activeTab === 'executions'"
                (click)="onTabChange('executions')">
                <i class="fa-solid fa-list-check"></i>
                Executions
            </button>
            }
        </div>

        <div class="tab-content">
            <div class="form-container" [class.hidden]="activeTab !== 'details'">
                <form (ngSubmit)="submitTestCase()">
                    @if (apiError) {
                    <div class="alert-error">
                        {{ apiError }}
                    </div>
                    }
                    <div class="form-row">
                        <div class="form-group">
                            <label for="test_case_key">Test Case Key</label>
                            <input type="text" id="test_case_key" [(ngModel)]="testCase.test_case_key"
                                name="test_case_key" placeholder="Enter test case key" [required]="!isEditMode"
                                [class.error]="errors.test_case_key" [disabled]="isEditMode" />
                            @if (errors.test_case_key) {
                            <span class="error-message">{{ errors.test_case_key }}</span>
                            }
                        </div>
                        <div class="form-group">
                            <label for="title">Title</label>
                            <input type="text" id="title" [(ngModel)]="testCase.title" name="title"
                                placeholder="Enter test case title" required [class.error]="errors.title" />
                            @if (errors.title) {
                            <span class="error-message">{{ errors.title }}</span>
                            }
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" [(ngModel)]="testCase.description" name="description"
                            placeholder="Enter test case description" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="folder">Folder</label>
                        <input type="text" id="folder" [(ngModel)]="testCase.folder" name="folder"
                            placeholder="Enter folder path" />
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="test_frequency">Test Frequency</label>
                            <div class="labels-dropdown" #frequencyDropdown>
                                <button type="button" class="dropdown-toggle" (click)="toggleFrequencyDropdown($event)">
                                    {{ selectedFrequencies.length ? (selectedFrequencies.join(', ')) : 'Select
                                    frequency' }}
                                    <i class="fa-solid fa-caret-down"></i>
                                </button>
                                @if (frequencyDropdownOpen) {
                                <ul class="dropdown-menu">
                                    @for (f of frequencyOptions; track f) {
                                    <li (click)="toggleFrequency($event, f)">
                                        <span class="option-text">{{ f }}</span>
                                        @if (selectedFrequencies.includes(f)) {
                                        <i class="fa-solid fa-check selected-check"></i>
                                        }
                                    </li>
                                    }
                                </ul>
                                }
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" [(ngModel)]="testCase.status" name="status">
                                <option value="DRAFT">DRAFT</option>
                                <option value="APPROVED">APPROVED</option>
                                <option value="DEPRECATED">DEPRECATED</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority</label>
                            <select id="priority" [(ngModel)]="testCase.priority" name="priority">
                                <option value="LOW">LOW</option>
                                <option value="MEDIUM">MEDIUM</option>
                                <option value="HIGH">HIGH</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="labels">Labels</label>
                        <div class="chip-options">
                            @for (l of allLabels; track l) {
                            <span class="chip-option" [class.selected]="selectedLabels.includes(l)" (click)="toggleLabel(l)">
                                {{ l }}
                            </span>
                            }
                        </div>

                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
                        <button type="submit" class="btn btn-primary">{{ isEditMode ? 'Update' : 'Create' }}</button>
                    </div>
                </form>
            </div>
            <div class="form-container" [class.hidden]="activeTab !== 'script'">
                <form (ngSubmit)="submitTestCase()">
                    <div class="form-group">
                        <label for="test_script">Test Script</label>
                        <div #editorContainer class="monaco-editor-container"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
                        <button type="submit" class="btn btn-primary" (click)="submitTestCase()">{{ isEditMode ?
                            'Update' :
                            'Create' }}</button>
                    </div>
                </form>
            </div>
            <div class="form-container" [class.hidden]="activeTab !== 'links'">
                <form (ngSubmit)="submitTestCase()">
                    <div class="form-group">
                        <label for="links">Links</label>
                        <textarea id="links" [(ngModel)]="testCase.links" name="links"
                            placeholder="Enter links (one per line or comma separated)"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
                        <button type="submit" class="btn btn-primary" (click)="submitTestCase()">{{ isEditMode ?
                            'Update' :
                            'Create' }}</button>
                    </div>
                </form>
            </div>
            @if (isEditMode) {
            <div class="form-container" [class.hidden]="activeTab !== 'executions'">
                <div class="executions-panel">
                    @if (executionsLoading) {
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading executions...</p>
                    </div>
                    } @else if (executionsError) {
                    <div class="alert-error">{{ executionsError }}</div>
                    } @else {
                    @if (executions && executions.length > 0) {
                    <div class="executions-list">
                        <div class="executions-header">
                            <span class="col-status">Status</span>
                            <span class="col-key">Key</span>
                            <span class="col-cycle">Cycle Key</span>
                            <span class="col-start">Start Date</span>
                            <span class="col-end">End Date</span>
                        </div>
                        @for (exe of executions; track exe.execution_key) {
                        <div class="execution-item clickable" [attr.data-status]="exe.result || 'NOT_EXECUTED'"
                            (click)="openExecution(exe.execution_key)">
                            <div class="execution-row">
                                <span class="col-status"><span class="execution-result">{{ exe.result || 'NOT_EXECUTED'
                                        }}</span></span>
                                <span class="col-key">{{ exe.execution_key }}</span>
                                <span class="col-cycle">{{ exe.test_cycle_key || '-' }}</span>
                                <span class="col-start">{{ exe.started_at || '-' }}</span>
                                <span class="col-end">{{ exe.finished_at || '-' }}</span>
                            </div>
                            <div class="execution-comment">{{ exe.comments || '' }}</div>
                        </div>
                        }
                    </div>
                    } @else {
                    <div class="empty-message">
                        <i class="fa-solid fa-flask"></i>
                        <p>No executions found for this test case</p>
                    </div>
                    }
                    }
                </div>
            </div>
            }
        </div>
    </div>
    }
</div>